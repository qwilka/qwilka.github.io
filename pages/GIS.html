<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Qwilka GIS</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
    integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
    integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
    crossorigin=""></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <script src="libs/geodesy/vector3d.js"></script>
    <script src="libs/geodesy/latlon-ellipsoidal.js"></script>
    <script src="libs/geodesy/utm.js"></script>
    <script src="libs/geodesy/dms.js"></script>
    <!-- <script src="https://unpkg.com/rbush@2.0.1/rbush.min.js"></script> -->

    <style>
        body { margin:0; padding:0; }
        body, table, tr, td, th, div, h1, h2, input { font-family: "Calibri", "Trebuchet MS", "Ubuntu", Serif; font-size: 11pt; }
        #map { position:absolute; top:0; bottom:0; width:100%; } /* full size */
        .ctl {
            padding: 2px 10px 2px 10px;
            background: white;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            text-align: right;
        }
        .title {
            font-size: 18pt;
            font-weight: bold;
        }
        .src {
            font-size: 10pt;
        }

    </style>

</head>
<body>

    <div id="map"></div>
    
    <script>
    //  .. White background
    var WhiteBG = L.tileLayer("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEAAQMAAABmvDolAAAAA1BMVEX///+nxBvIAAAAH0lEQVQYGe3BAQ0AAADCIPunfg43YAAAAAAAAAAA5wIhAAAB9aK9BAAAAABJRU5ErkJggg==");

    var OSMobj = {
        baseUrl: "http://ows.terrestris.de/osm/service",
        options: {
            layers: ["TOPO-OSM-WMS"],
            CRS: "EPSG:4326",
            format: 'image/png',
            maxZoom: 12,
            noWrap: true,
            transparent: false,
            opacity: 0.7,
            attribution: "OSM"	
        }
    }
    var OSM = L.tileLayer.wms(OSMobj.baseUrl, OSMobj.options)

    var GEBCOobj = {
        baseUrl: "https://www.gebco.net/data_and_products/gebco_web_services/web_map_service/mapserv",
        options: {
            layers: ["GEBCO_LATEST"],
            CRS: "EPSG:4326",
            format: 'image/png',
            maxZoom: 12,
            noWrap: true,
            transparent: false,
            opacity: 0.7,
            attribution: "GEBCO"	
        }
    }
    var GEBCO = L.tileLayer.wms(GEBCOobj.baseUrl, GEBCOobj.options)
    // layers: ["GEBCO_LATEST"],
    // baseUrl: "https://www.gebco.net/data_and_products/gebco_web_services/web_map_service/mapserv?request=getmap&service=wms&BBOX=-90,-180,90,180&crs=EPSG:4326&format=image/jpeg&layers=gebco_latest&width=900&height=600&version=1.3.0",
    //baseUrl: "http://www.gebco.net/data_and_products/gebco_web_services/web_map_service/mapserv?",

    var GEBCOsigObj = {
        baseUrl: "https://www.gebco.net/data_and_products/gebco_web_services/web_map_service/mapserv",
        options: {
            layers: ["GEBCO_LATEST_sid"],
            CRS: "EPSG:4326",
            format: 'image/png',
            maxZoom: 12,
            noWrap: true,
            transparent: true,
            opacity: 0.6,
            attribution: "GEBCO"	
        }
    }
    var GEBCOsig = L.tileLayer.wms(GEBCOsigObj.baseUrl, GEBCOsigObj.options)
    //baseUrl: "https://www.gebco.net/data_and_products/gebco_web_services/web_map_service/mapserv?request=getmap&service=wms&BBOX=-90,-180,90,180&crs=EPSG:4326&format=image/jpeg&layers=gebco_latest_sid&width=900&height=600&version=1.3.0",

    var NPDobj = {
        baseUrl: "http://gis.npd.no/ogc/factmaps/2_0",
        options: {
            layers: ['dscAll', 'pplAll', 'fclFixed'],
            CRS: "EPSG:23032",
            format: 'image/png',
            transparent: true,
            noWrap: true,
            opacity: 0.9,
            attribution: "NPD"
        }
    }
    var NPD = L.tileLayer.wms(NPDobj.baseUrl, NPDobj.options)

    // https://data.gov.ie/dataset/offshore-gas-pipeline
    var IREobj = {
        baseUrl: "http://atlas.marine.ie/arcgis/services/EnergyResourcesInfrastructure/MapServer/WMSServer",
        options: {
            layers: ['2'],
            CRS: "EPSG:4326",
            format: 'image/png',
            transparent: true,
            noWrap: true,
            opacity: 0.9,
            attribution: ""
        }
    }
    var IRE = L.tileLayer.wms(IREobj.baseUrl, IREobj.options)

    // // http://www.arcgis.com/home/item.html?id=03a2802ec17d4512801d6f9b9ed84942
    // var LAobj = {
    //     baseUrl: "http://atlas.marine.ie/arcgis/services/EnergyResourcesInfrastructure/MapServer/WMSServer",
    //     options: {
    //         layers: ['NRG_LA_PipelinesOffshore_2007'],
    //         CRS: "EPSG:4326",
    //         format: 'image/png',
    //         transparent: true,
    //         noWrap: true,
    //         opacity: 0.9,
    //         attribution: ""
    //     }
    // }
    // var LA = L.tileLayer.wms(LAobj.baseUrl, LAobj.options)

    var map = L.map('map', {
        attributionControl: true,
        zoom: 5,
        minZoom: 1,
        maxZoom: 18,
        center: [57.0, 2.46],
        layers: [GEBCO]
    });

    // var map = L.map('map', {
    //     attributionControl: false,
    //     center: [65.44605898069102, 7.263163986321805],
    //     zoom: 20,
    //     minZoom: 1,
    //     maxZoom: 18,
    //     layers: [GEBCO, NPD]
    // });

    var basemaps = {
        "GEBCO": GEBCO,
        "OpenStreetMap": OSM,
        "white background": WhiteBG
    }
    var overlaymaps = {
        "Ireland offshore pipelines": IRE,
        "Norwegian Petroleum Directorate": NPD,
        "GEBCO source identifier": GEBCOsig
    }

    var title = L.control();
    title.onAdd = function(map) {
        this._div = L.DomUtil.create('div', 'ctl title');
        this.update();
        return this._div;
    };
    title.update = function(props) {
        this._div.innerHTML = "Qwilka GIS";
    };
    title.addTo(map);

    L.control.layers(basemaps, overlaymaps, {collapsed: true}).addTo(map);

    var scale = L.control.scale({position:'bottomright', metric:true, imperial:false});
    scale.addTo(map);

    // map.setView([65.75, 7.58], 10);

    var popup = L.popup()
    function onMapClick(evt) {
        var X = map.layerPointToContainerPoint(evt.layerPoint).x;
        var Y = map.layerPointToContainerPoint(evt.layerPoint).y;
        // var point = map.latLngToContainerPoint(evt.latlng, map.getZoom());
        // X=point.x; Y=point.y;
        var size = map.getSize() 
        //var featURL = 'https://www.gebco.net/data_and_products/gebco_web_services/web_map_service/mapserv?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo&LAYERS=GEBCO_LATEST_2&propertyName=Zone_Urb,Type_Urb&STYLES=&BBOX='+BBOX+'&FEATURE_COUNT=5&HEIGHT='+HEIGHT+'&WIDTH='+WIDTH+'&FORMAT=image%2Fpng&INFO_FORMAT=text%2fhtml&SRS=EPSG%3A4326&X='+X+'&Y='+Y;
        params = {
          request: 'GetFeatureInfo',
          service: 'WMS',
          srs: 'EPSG:4326',
          version: '1.1.1',      
          bbox: map.getBounds().toBBoxString(),
          format: GEBCO.options.format,
          x: X,
          y: Y,
          height: size.y,
          width: size.x,
          layers: 'GEBCO_LATEST_2',
          query_layers: 'GEBCO_LATEST_2',
          info_format: 'text/html'
        };
        // info_format: 'text/html'  'application/json'
        var featInfoUrl = GEBCOobj.baseUrl + L.Util.getParamString(params, GEBCOobj.baseUrl, true)
var elevation = "WAIT"
var getinfo = $.ajax({
 url: featInfoUrl,
 dataType: "html",
 success: console.log("getinfo successfully loaded!"),
 error: function (xhr) {
    alert(xhr.statusText)
 }
})
$.when(getinfo).done(function() {
            var htmlstr = $.parseHTML( getinfo.responseText );
            //var body = $(htmlstr).find('body:first');
            var body = $(htmlstr).find('body:first');
            $.each(htmlstr, function(i, el){
                //console.log(i, el)
                if (el.nodeName == '#text') {
                    var targetStr = el.nodeValue
                    console.log(i, targetStr);
                    var test = targetStr.match(/Elevation value \(m\):\s*(-?\d+)/)
                    if (test) {
                        elevation = test[1];
                        pustr += "<br>elevation/depth " + elevation + " m (GEBCO)"
                        console.log("elevation=", elevation)
                        popup.setContent(pustr)
                    }
                    // var loc1 = targetStr.search("(m)");
                    // var loc2 = targetStr.search("Derived");
                    // if (loc > 0) {
                    //     console.log("loc=", loc)
                    //     console.log(target.slice(loc+20, loc+25))
                    // }
                }
            });
            // parser = new DOMParser();
            // doc = parser.parseFromString(htmlstr, "text/html");
            //var body = $("body",$(htmlstr)).html();
            //console.log(body);
        });

        var lat = evt.latlng.lat
        var long = evt.latlng.lng
        var latlong_WGS84 = new LatLon(lat, long, LatLon.datum.WGS84);
        var latlong_ED50 = latlong_WGS84.convertDatum(LatLon.datum.ED50);
        var utmCoord = latlong_ED50.toUtm();
        var pustr = "Location coordinates:";
        pustr += "<br>long. " + (long).toFixed(5) + "&deg;  lat. " + (lat).toFixed(5) + "&deg; (WGS84)";
        pustr += "<br>UTM zone " + utmCoord.zone + utmCoord.hemisphere;
        pustr += "<br>E" + (utmCoord.easting).toFixed(1) + " N" + (utmCoord.northing).toFixed(1) + " (ED50)";
        // pustr += "<br>X" + X + " Y" + Y + " size.x" + size.x + " size.y" + size.y;
        // pustr += "<br>zoom: " + map.getZoom() + " layer: " + GEBCO.options.layers + " format: " + GEBCO.options.format;
        console.log(featInfoUrl)
      popup
        .setLatLng(evt.latlng)
        .setContent(pustr)
        .openOn(map)
    }
    map.on('contextmenu', onMapClick)

    </script>

</body>
</html>