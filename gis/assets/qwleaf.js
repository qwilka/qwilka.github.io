!function(e){var t={};function o(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,o),n.l=!0,n.exports}o.m=e,o.c=t,o.d=function(e,t,a){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(o.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(a,n,function(t){return e[t]}.bind(null,n));return a},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/gis/assets/",o(o.s=0)}([function(e,t,o){"use strict";o.r(t);const a=(e,t)=>{let o=t.node;o.data.hasOwnProperty("_widgetData")||(o.data._widgetData={})},n=(e,t)=>t.typeInfo.icon,i=(e,t)=>t.typeInfo.iconTooltip,s=(e,t)=>{let o=t.tree.getOption("targetWidget"),a=t.node;switch(t.node.type){case"gis-layer-basemap":c(t.tree);break;case"gis-layer":if(a.isSelected()){let e=Object.assign({},a.data);a.data._widgetData.layerStamp=o.addLayer(e)}else o.removeLayerByStamp(a.data._widgetData.layerStamp);break;default:console.log(`select_datatree ${a.title} ${a.type}`)}},r=(e,t)=>{let o=t.node;t.result={url:o.data.fancytree,data:{mode:"children",parent:o.key},cache:!1}},l=(e,t)=>{c(t.tree)},c=e=>{let t=e.getOption("targetWidget"),o=e.getRootNode();t.removeAllLayers(),o.visit(e=>{if(e.data._widgetData={},e.type&&e.isSelected()&&["gis-layer","gis-layer-basemap"].includes(e.type)){let o=Object.assign({},e.data);e.data._widgetData.layerStamp=t.addLayer(o)}})},p=(e,t)=>{let o=$.ui.fancytree.getNode(e),a=o.tree.getOption("targetWidget");switch(o.type){case"gis-layer":return{items:{fitBoundsBbox:{name:"zoom-to",icon:"fas fa-arrows-alt",disabled:function(e,t){return!o.data.hasOwnProperty("bbox")},callback:function(e,t){a.fitBoundsBbox(o.data.bbox)}},"console-message":{name:"msg to console",icon:"fas fa-globe",callback:(e,t)=>{console.log("gis-widget: console-message: testing context menu");let o=a.getMapBounds();console.log("map bounds: ",o)}}}}}};var d=!1;class g{constructor({id_number:e=0,gisOptions:t=null}={}){if(this.id_number=e,this.map_id="vn-map-"+e.toString(),this.geoMarker=null,this.map=L.map(this.map_id,t.mapOptions),this.map.zoomControl&&this.map.zoomControl.setPosition("topright"),t.sidePanel){let e="vn-map-ebutton-"+this.id_number.toString();L.easyButton("fas fa-bars",(e,t)=>{let o="vn-sidepanel-"+this.id_number.toString();document.getElementById(o).style.display="block"},"open side-panel controls",e).addTo(this.map)}if(t.locationPopup&&(this.popup=L.popup(),this.map.on("contextmenu",e=>{this.locationPopup(e)})),t.scaleControl){L.control.scale({position:"bottomright",metric:!0,imperial:!1}).addTo(this.map)}t.hasOwnProperty("useCache")&&(d=t.useCache)}addLayer(e){let t;switch(e.layerType){case"geojson":t=function(e,t){let o=t.map,a=null;e.hasOwnProperty("layerOpts")&&(a=e.layerOpts.attribution||null);let n=new L.GeoJSON(null,{style:function(t){let o={color:"#ff0000",weight:2,opacity:1};if(e.hasOwnProperty("style")){if(e.style.hasOwnProperty("default")&&(Object.assign(o,e.style.default),!0===e.style.default.color&&t.properties.hasOwnProperty("color"))){let e=t.properties.color;/^(0x)?[0-9a-fA-F]+$/.test(e)&&(e.startsWith("0x")&&(e=e.slice(2)),e.startsWith("#")||(e="#"+e)),o.color=e}for(const[a,n]of Object.entries(e.style))if(a.indexOf("|")>0){let[e,i]=a.split("||");t.properties.hasOwnProperty(e)&&t.properties[e].toLowerCase()===i.toLowerCase()&&Object.assign(o,n)}}else t.properties.hasOwnProperty("style")&&(o=t.properties.style);return o},onEachFeature:function(a,n){n.on({click:function(t){L.DomEvent.stopPropagation(t);t.latlng.lat,t.latlng.lng;let n="";if(a.properties.hasOwnProperty("name")&&(n+="<b>"+a.properties.name+"</b>"),e.hasOwnProperty("popupProps"))for(let t=0;t<e.popupProps.length;t++){let o=e.popupProps[t].split("||"),i=o[0],s=o[0];o.length>1&&(s=o[1]),a.properties.hasOwnProperty(i)&&(n+=`<br>${s}: ${a.properties[i]}`)}if(a.properties.hasOwnProperty("KP")){let e=getFeatureKPvalue(a);n+="<br> KP: "+parseFloat(e).toFixed(3)}L.popup().setLatLng(t.latlng).setContent(n).openOn(o)},contextmenu:function(e){L.DomEvent.stopPropagation(e);let o="";if(a.properties.hasOwnProperty("name")&&(o+="<b>"+a.properties.name+"</b>"),a.properties.hasOwnProperty("KP")){let e=getFeatureKPvalue(a);o+="<br> KP: "+parseFloat(e).toFixed(3)}t.locationPopup(e,o)}})},attribution:a,pointToLayer:function(t,o){return L.circleMarker(o,e.layerOpts.geojsonMarkerOptions)}}),i=!1;d&&e.cache&&(i=localStorage.getItem(e.layerId));i?(console.log("localStorage retrieving "+e.layerId),i=LZString.decompressFromUTF16(i),i=JSON.parse(i),console.log("dataObj.cache_timestamp "+i.cache_timestamp),n.addData(i.data)):fetch(e.url).then(t=>{200!=t.status&&console.error(`loadGeojson failure\nurl=«${url}»\nfetch response status code: ${t.status}`),t.json().catch(e=>{console.error("loadGeojson failure\nresp.json():",e)}).then(t=>{console.log("loadGeojson data",t),n.addData(t),i={cache_timestamp:Date.now(),type:"geojson",data:t},i=JSON.stringify(i),console.log("dataObj length",i.length),i=LZString.compressToUTF16(i),console.log("compressed length",i.length);try{localStorage.setItem(e.layerId,i)}catch(t){console.error(`localStorage ${t} ${e.layerId}`)}})}).catch(t=>{console.error(`loadGeojson fetch(${e.url}) failure: ${t}`)});return n}(e,this);break;case"tilemap":t=L.tileLayer(e.url,e.layerOpts);break;case"WMS":t=L.tileLayer.wms(e.url,e.layerOpts)}return this.map.addLayer(t),L.Util.stamp(t)}getLayerByStamp(e){let t=[];this.map.eachLayer(e=>{t.push(e)});for(let o=0;o<t.length;o++)if(t[o]._leaflet_id==e)return t[o]}removeLayerByStamp(e){let t=this.getLayerByStamp(e);this.map.removeLayer(t)}removeAllLayers(){this.map.eachLayer(e=>{this.map.removeLayer(e)})}getAllAttributions(){let e=[];this.map.eachLayer(t=>{e.push(t)});let t=[];for(let o=0;o<e.length;o++)t.push(e[o].getAttribution());return t}getMapBounds(){let e=this.map.getBounds();return e=e.toBBoxString(),e}fitBoundsBbox(e){this.map.fitBounds([[e[1],e[0]],[e[3],e[2]]])}locationPopup(e,t=null){let o,a="https://www.gebco.net/data_and_products/gebco_web_services/web_map_service/mapserv",n=this.map.layerPointToContainerPoint(e.layerPoint).x,i=this.map.layerPointToContainerPoint(e.layerPoint).y,s=this.map.getSize(),r=this.popup;o=t?t+"<br>Location coordinates:":"Location coordinates:";let l={request:"GetFeatureInfo",service:"WMS",srs:"EPSG:4326",version:"1.1.1",bbox:this.map.getBounds().toBBoxString(),x:n,y:i,height:s.y,width:s.x,layers:"GEBCO_LATEST_2",query_layers:"GEBCO_LATEST_2",info_format:"text/html"},c=a+L.Util.getParamString(l,a,!0),p=$.ajax({url:c,dataType:"html",success:function(e){console.log("getinfo successfully loaded!\n",e)},error:function(e){console.log("getinfo ERROR!\n",e.statusText)}});$.when(p).done((function(){let e=$.parseHTML(p.responseText);$(e).find("body:first");$.each(e,(function(e,t){if("#text"==t.nodeName){let e=t.nodeValue.match(/Elevation value \(m\):\s*(-?\d+)/);if(e){let t=e[1];o+=t>=0?"<br>elevation "+t+" m (GEBCO)":"<br>depth "+t+" m (GEBCO)",r.setContent(o)}}}))}));let d=e.latlng.lat,g=e.latlng.lng;console.log("long",g,"lat",d);let u=new LatLon(d,g),h=u.convertDatum(LatLon.datums.ED50);console.log("latlong_WGS84 ",u.toString()),h=new LatLon(h.lat,h.lon,0,LatLon.datums.ED50);let m=h.toUtm();o+="<br> "+u.toString(),o+="<br>UTM zone "+m.zone+m.hemisphere,o+="<br>E"+m.easting.toFixed(1)+" N"+m.northing.toFixed(1)+" (ED50)",this.popup.setLatLng(e.latlng).setContent(o).openOn(this.map)}}window.geosearch=function(e){let t,o,a;t=document.getElementById("geosearch").value,console.log("in window.geosearch",t),console.log("Input value: "+t),o=LatLon.parse("58°38′38″N, 003°04′12″W"),console.log(`58°38′38″N, 003°04′12″W\nlong=${o.lng} lat=${o.lat}`),o=null;try{o=LatLon.parse(t)}catch(e){console.log("LatLon.parse(el.value) error1= "+e),o=null}if(!o)try{o=LatLon.parse(t.replace(" ",", "))}catch(e){console.log("LatLon.parse(el.value) error2= "+e),o=null}let n=document.getElementById("geosearch-result");if(o){a="<ul class='w3-ul w3-border w3-small'>",a+=`<li> long=${o.lng} lat=${o.lat} </li>`,a+="</ul>";let e={lat:o.lat,lng:o.lng};app.gis.map.setView(e,app.gis.map.getZoom()),console.log("map.setView",o.toString()),app.gis.map.hasLayer(app.gis.geoMarker)?app.gis.geoMarker.setLatLng(e):(app.gis.geoMarker=L.marker(e),app.gis.map.addLayer(app.gis.geoMarker))}else a="<ul class='w3-ul w3-border w3-small'>",a+=`<li><span style="color:red">Error parsing «${t}», re-enter Lat,Long coordinates.</span><br>e.g. for London enter <br>51.5, 0<br>Note: coodinates can be copied from Wikipedia page, e.g.<br>51°30′26″N 0°7′39″W</li>`,a+="</ul>";n.innerHTML=a},window.clearGeosearch=function(e){document.getElementById("geosearch").value="",document.getElementById("geosearch-result").innerHTML="",app.gis.map.removeLayer(app.gis.geoMarker)};class u{constructor({app_id:e,gisOptions:t,ftree_vnleaf_0:o,id_number:c=0,title:d="qwleaf testing..."}={}){this.id_number=c,this.id=e;const u=document.getElementById(e),h=document.createElement("div");this.sidepanel_id="vn-sidepanel-"+this.id_number.toString(),h.setAttribute("id",this.sidepanel_id),h.setAttribute("class","w3-sidebar w3-bar-block w3-border-right"),h.setAttribute("style","display:none;z-index:2000;width:300px;height:100%;"),u.appendChild(h);const m=document.createElement("div");m.setAttribute("class","w3-row"),h.appendChild(m);const f=document.createElement("div");f.setAttribute("class","w3-col w3-right w3-blue-grey"),f.setAttribute("style","width:40px;height:50px;"),m.appendChild(f);const b=document.createElement("button");b.setAttribute("class","w3-bar-item w3-button w3-dark-grey"),b.setAttribute("title","close side panel"),b.setAttribute("style","width:40px;height:50px;"),b.onclick=e=>{this.sidepanel_close()},f.appendChild(b);const y=document.createElement("i");y.setAttribute("class","fas fa-caret-left w3-xxlarge"),b.appendChild(y);const w=document.createElement("div");w.setAttribute("class","w3-rest w3-center w3-blue-grey"),w.setAttribute("style","height:50px;"),m.appendChild(w),this.spTopTitleCol=w;const L=document.createElement("div");L.setAttribute("class","w3-row"),L.setAttribute("style","height:100%;"),h.appendChild(L);const v=document.createElement("div");v.setAttribute("class","w3-col w3-border w3-light-gray"),v.setAttribute("style","width:32px;height:100%;"),L.appendChild(v),this.spTabCol=v;const _=document.createElement("div");_.setAttribute("class","w3-rest"),L.appendChild(_),this.spMainCol=_,u.setAttribute("style","position:fixed; top:0; left:0; bottom:0; right:0;");const S="vn-map-"+c.toString(),O=document.createElement("div");O.setAttribute("style","width: 100%; height: 100%; margin: 0 auto;"),O.setAttribute("id",S),u.appendChild(O),this.gis=new g({id_number:this.id_number,gisOptions:t});const A=this.createSpWidget("layers","Select map layers","fas fa-layer-group");let x="vn-datatree-"+this.id_number.toString();A.setAttribute("id",x),console.log("datatree_id="+x),x=((e=null,t=0,o=null)=>{const c="vn-datatree-"+t.toString();return $("#"+c).fancytree({extensions:["glyph"],glyph:{preset:"awesome5",map:{}},imagePath:"",types:{"folder-gis-basemaps":{iconTooltip:"select the base map"},"gis-layer-basemap":{icon:!1},"gis-layer":{icon:!1},DISABLED:{icon:"far fa-eye-slash",iconTooltip:"DISABLED"},"gis-folder-flag-au":{icon:"flag-icon-background flag-icon-au"},"gis-folder-flag-dk":{icon:"flag-icon-background flag-icon-dk"},"gis-folder-flag-gb":{icon:"flag-icon-background flag-icon-gb"},"gis-folder-flag-gb-sct":{icon:"flag-icon-background flag-icon-gb-sct"},"gis-folder-flag-ie":{icon:"flag-icon-background flag-icon-ie"},"gis-folder-flag-no":{icon:"flag-icon-background flag-icon-no"},"gis-folder-flag-us":{icon:"flag-icon-background flag-icon-us"}},icon:n,iconTooltip:i,select:s,lazyLoad:r,init:l,source:e,id_number:t,targetWidget:o,treeId:"vn-fancytree-"+t.toString(),createNode:a}),$.contextMenu({selector:"#"+c+" span.fancytree-title",build:p}),c})(o,this.id_number,this.gis),console.log("datatree_id="+x),this.datatree=((e=0)=>{const t="vn-datatree-"+e.toString();return $.ui.fancytree.getTree("#"+t)})(this.id_number),this.createSpWidget("attributions","Map attributions","far fa-copyright");let P=this.createSpWidget("geosearch","Search","fas fa-search");const C=document.createElement("div");C.setAttribute("id","geosearchbox"),C.innerHTML='<div class="w3-container w3-border"> \n    <div class="w3-row w3-section">\n    <div class="w3-rest">\n      <input class="w3-input w3-border w3-border-green" id="geosearch" name="loc" type="text" placeholder="input Lat,Long coordinates" onchange="geosearch(this)"/>\n    </div>\n    </div>\n      <div class="w3-row w3-section">\n      <button class="w3-button w3-left w3-green" onclick="geosearch()">Search</button>\n      <button class="w3-button w3-right w3-green" onclick="clearGeosearch()">Clear</button>\n      </div>\n    </div>',P.appendChild(C);const E=document.createElement("div");E.setAttribute("id","geosearch-result"),P.appendChild(E),this.createSpWidget("help","Help","fas fa-question").innerHTML='<div class="w3-container w3-border"> \n<h2>Help</h2>\n<p>Help is not yet available ...</p>\n<hr>\n</div>',this.createSpWidget("options","Options","fas fa-cog").innerHTML='<div class="w3-container w3-border"> \n  <h2>Options</h2>\n  <p>No set-able options currently available ....</p>\n  <hr>\n</div>',this.showSidepanelWidget("layers")}sidepanel_open(){document.getElementById(this.sidepanel_id).style.display="block"}sidepanel_close(){let e="vn-sidepanel-"+this.id_number;document.getElementById(e).style.display="none"}showSidepanelWidget(e){for(let t=0;t<this.spMainCol.childNodes.length;t++){let o=this.spMainCol.childNodes[t];if(e===o.getAttribute("data-ident")){let e=o.getAttribute("data-title");this.spTopTitleCol.innerHTML="<p>"+e+"</p>",o.style.display="block"}else o.style.display="none"}}createSpWidget(e,t,o){const a=document.createElement("div");a.setAttribute("style","display:none;"),a.setAttribute("id","sp-"+e),a.setAttribute("data-ident",e),a.setAttribute("data-title",t),this.spMainCol.appendChild(a);const n=document.createElement("button");let i;switch(n.setAttribute("class","w3-button w3-dark-grey"),n.setAttribute("style","margin:1px;padding:4px 2px 2px 2px;height:32px;width:32px;"),n.setAttribute("title",t),e){case"attributions":i=t=>{this.showSidepanelWidget(e);let o=this.gis.getAllAttributions(),n="<ul class='w3-ul w3-border w3-small'>",i="";for(let e=0;e<o.length;e++){if(!o[e])continue;if(i===o[e])continue;i=o[e];let t="";this.datatree.getRootNode().visit(a=>{if(a.data.hasOwnProperty("layerOpts")&&a.data.layerOpts.hasOwnProperty("attribution")&&a.data.layerOpts.attribution===o[e])return t=`<b>${a.title}</b>: `,!1}),n+="<li>"+t+o[e]+"</li>"}n+="</ul>",a.innerHTML=n};break;default:i=t=>{this.showSidepanelWidget(e)}}n.onclick=i;const s=document.createElement("i");return s.setAttribute("class",o),n.appendChild(s),this.spTabCol.appendChild(n),a}onActivateRequest(e){console.log("onActivateRequest(",this.id,e)}onAfterHide(e){console.log("onAfterHide",this.id,e)}onAfterShow(e){console.log("onAfterShow",this.id,e)}onAfterAttach(e){console.log("onAfterAttach",this.id,e)}onCloseRequest(e){console.log("onCloseRequest",this.id,e)}onResize(e){this.map&&console.log("onResize",this.id,e)}}window.onload=()=>{!function(){let e,t,o=new URL(window.location.href);o.searchParams.has("conf")?(t=o.searchParams.get("conf"),e="/gis/assets/"+t+".vnleaf.json"):(console.log("main using default config",conf_data_path),e=conf_data_path),fetch(e).then(e=>{200!=e.status&&console.error(`load_config failure\nurl=«${o}»\nfetch response status code: ${e.status}`),e.json().catch(e=>{console.error("load_config failure\nresp.json():",e)}).then(e=>{console.log("confData",e),app=new u(e)})}).catch(t=>{console.error(`fetch(${e}) failure top-level: ${t}`)})}()}}]);